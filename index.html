<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TestMaster ‚Äî –û–Ω–ª–∞–π–Ω –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è</title>
<link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;600;800&family=Manrope:wght@300;400;500;600&display=swap" rel="stylesheet">

<!-- ======= FIREBASE CONFIG ‚Äî –ó–ê–ú–Ü–ù–ò–¢–ò –ù–ê –°–í–û–á –î–ê–ù–Ü ======= -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
    signOut, onAuthStateChanged, updateProfile
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, collection, doc, setDoc, getDoc, getDocs,
    addDoc, deleteDoc, query, orderBy, serverTimestamp, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ‚ö†Ô∏è –ó–ê–ú–Ü–ù–ò–¢–ò –ù–ê –í–õ–ê–°–ù–Ü FIREBASE CREDENTIALS
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Expose to global scope for non-module scripts
  window._fb = { auth, db, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile,
    collection, doc, setDoc, getDoc, getDocs, addDoc, deleteDoc, query, orderBy, serverTimestamp, onSnapshot };

  // Auth state listener
  onAuthStateChanged(auth, (user) => {
    window._fbUser = user;
    if (user) {
      document.getElementById('page-login')?.classList.remove('active');
      document.getElementById('page-register')?.classList.remove('active');
      document.getElementById('main-nav').style.display = 'flex';
      document.getElementById('nav-user-name').textContent = user.displayName || user.email;
      const isAdmin = user.email === window._adminEmail;
      document.getElementById('nav-tab-admin').style.display = isAdmin ? '' : 'none';
      document.getElementById('nav-tab-manage').style.display = isAdmin ? '' : 'none';
      if (!window._appReady) {
        window._appReady = true;
        loadFromFirebase().then(() => showPage('home'));
      }
    } else {
      window._appReady = false;
      document.getElementById('main-nav').style.display = 'none';
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-login').classList.add('active');
    }
  });
</script>

<style>
  :root {
    --bg: #0a0a0f;
    --surface: #111118;
    --card: #16161f;
    --border: #2a2a3a;
    --accent: #7c3aed;
    --accent2: #06b6d4;
    --accent3: #f59e0b;
    --text: #e8e8f0;
    --muted: #6b6b80;
    --danger: #ef4444;
    --success: #10b981;
    --radius: 14px;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Manrope', sans-serif;
    background: var(--bg); color: var(--text);
    min-height: 100vh; overflow-x: hidden;
  }
  body::before {
    content: '';
    position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
    background: radial-gradient(ellipse at 30% 20%, rgba(124,58,237,0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(6,182,212,0.06) 0%, transparent 50%);
    pointer-events: none; z-index: 0;
  }

  .page { display: none; position: relative; z-index: 1; min-height: 100vh; }
  .page.active { display: flex; flex-direction: column; }

  /* NAV */
  .nav {
    display: flex; align-items: center; justify-content: space-between;
    padding: 18px 32px;
    background: rgba(17,17,24,0.85); backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    position: sticky; top: 0; z-index: 100;
  }
  .nav-logo {
    font-family: 'Unbounded', sans-serif; font-size: 18px; font-weight: 800;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .nav-right { display: flex; align-items: center; gap: 12px; }
  .nav-tabs { display: flex; gap: 4px; }
  .nav-tab {
    padding: 8px 18px; border-radius: 8px; border: none;
    background: transparent; color: var(--muted);
    font-family: 'Manrope', sans-serif; font-size: 14px; font-weight: 500;
    cursor: pointer; transition: all 0.2s;
  }
  .nav-tab:hover { background: var(--card); color: var(--text); }
  .nav-tab.active { background: var(--accent); color: #fff; }
  .nav-user {
    display: flex; align-items: center; gap: 10px;
    padding: 6px 14px; background: var(--card); border: 1px solid var(--border);
    border-radius: 50px; font-size: 13px;
  }
  .nav-avatar {
    width: 28px; height: 28px; border-radius: 50%;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 700; color: #fff; flex-shrink: 0;
  }

  /* BUTTONS */
  .btn {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 10px 20px; border-radius: 10px; border: none;
    font-family: 'Manrope', sans-serif; font-size: 14px; font-weight: 600;
    cursor: pointer; transition: all 0.2s; text-decoration: none;
  }
  .btn-primary { background: var(--accent); color: #fff; }
  .btn-primary:hover { background: #6d28d9; transform: translateY(-1px); box-shadow: 0 8px 24px rgba(124,58,237,0.35); }
  .btn-secondary { background: var(--card); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { background: var(--border); }
  .btn-danger { background: rgba(239,68,68,0.15); color: var(--danger); border: 1px solid rgba(239,68,68,0.3); }
  .btn-danger:hover { background: var(--danger); color: #fff; }
  .btn-success { background: var(--success); color: #fff; }
  .btn-cyan { background: var(--accent2); color: #000; }
  .btn-cyan:hover { background: #0891b2; }
  .btn-lg { padding: 14px 32px; font-size: 16px; border-radius: 12px; }
  .btn-sm { padding: 6px 12px; font-size: 12px; border-radius: 8px; }
  .btn-ghost { background: transparent; color: var(--muted); border: 1px solid var(--border); }
  .btn-ghost:hover { color: var(--text); background: var(--card); }

  /* FORMS */
  .input, .select, .textarea {
    width: 100%; padding: 10px 14px; border-radius: 10px;
    background: var(--bg); color: var(--text); border: 1px solid var(--border);
    font-family: 'Manrope', sans-serif; font-size: 14px;
    transition: border-color 0.2s, box-shadow 0.2s; outline: none;
  }
  .input:focus, .select:focus, .textarea:focus {
    border-color: var(--accent); box-shadow: 0 0 0 3px rgba(124,58,237,0.15);
  }
  .textarea { resize: vertical; min-height: 70px; }
  .select option { background: var(--surface); }
  .form-label { display: block; font-size: 13px; font-weight: 500; color: var(--muted); margin-bottom: 6px; }
  .form-group { margin-bottom: 16px; }
  .form-error { font-size: 12px; color: var(--danger); margin-top: 6px; display: none; }

  /* CARDS */
  .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; }

  /* AUTH PAGES */
  .auth-wrap {
    flex: 1; display: flex; align-items: center; justify-content: center;
    padding: 40px 20px;
  }
  .auth-box { width: 100%; max-width: 400px; }
  .auth-logo {
    font-family: 'Unbounded', sans-serif; font-size: 26px; font-weight: 800;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    text-align: center; margin-bottom: 6px;
  }
  .auth-sub { color: var(--muted); font-size: 14px; text-align: center; margin-bottom: 28px; }
  .auth-switch { text-align: center; margin-top: 16px; font-size: 13px; color: var(--muted); }
  .auth-switch a { color: #a78bfa; cursor: pointer; text-decoration: underline; }
  .input-icon { position: relative; }
  .input-icon .input { padding-left: 40px; }
  .input-icon .icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); font-size: 16px; pointer-events: none; }
  .divider-text { display: flex; align-items: center; gap: 12px; margin: 16px 0; color: var(--muted); font-size: 12px; }
  .divider-text::before, .divider-text::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  /* HOME */
  #page-home { align-items: center; justify-content: center; text-align: center; padding: 40px 20px; }
  .hero-badge {
    display: inline-flex; align-items: center; gap: 8px;
    background: rgba(124,58,237,0.15); border: 1px solid rgba(124,58,237,0.3);
    border-radius: 50px; padding: 6px 16px;
    font-size: 12px; font-weight: 600; color: #a78bfa; letter-spacing: 0.5px;
    text-transform: uppercase; margin-bottom: 24px;
    animation: fadeInDown 0.6s ease;
  }
  .hero-title {
    font-family: 'Unbounded', sans-serif;
    font-size: clamp(32px, 6vw, 62px); font-weight: 800;
    line-height: 1.1; letter-spacing: -2px; margin-bottom: 20px;
    animation: fadeInUp 0.7s ease;
  }
  .hero-title span {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .hero-sub { font-size: 18px; color: var(--muted); max-width: 500px; line-height: 1.6; margin-bottom: 36px; animation: fadeInUp 0.8s ease; }
  .hero-actions { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; animation: fadeInUp 0.9s ease; }
  .hero-stats { display: flex; gap: 32px; margin-top: 60px; flex-wrap: wrap; justify-content: center; animation: fadeInUp 1s ease; }
  .stat { text-align: center; }
  .stat-num {
    font-family: 'Unbounded', sans-serif; font-size: 28px; font-weight: 800;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .stat-label { font-size: 13px; color: var(--muted); margin-top: 4px; }

  /* ADMIN */
  #page-admin { padding: 0; }
  .admin-body { padding: 32px; max-width: 1100px; margin: 0 auto; flex: 1; }
  .page-header { margin-bottom: 28px; }
  .page-title { font-family: 'Unbounded', sans-serif; font-size: 24px; font-weight: 700; letter-spacing: -1px; }
  .page-sub { color: var(--muted); font-size: 14px; margin-top: 4px; }
  .admin-grid { display: grid; grid-template-columns: 1fr 1.4fr; gap: 24px; }
  .section-title {
    font-family: 'Unbounded', sans-serif; font-size: 14px; font-weight: 600;
    color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 16px;
  }

  /* Question list */
  .question-list { display: flex; flex-direction: column; gap: 12px; }
  .question-item {
    background: var(--card); border: 1px solid var(--border); border-radius: 12px;
    padding: 16px; cursor: pointer; transition: all 0.2s;
  }
  .question-item:hover { border-color: var(--accent); transform: translateY(-1px); }
  .question-item.editing { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(124,58,237,0.15); }
  .question-item-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 12px; }
  .question-num {
    font-family: 'Unbounded', sans-serif; font-size: 10px; font-weight: 700;
    background: var(--accent); color: #fff; border-radius: 6px; padding: 3px 8px; flex-shrink: 0;
  }
  .question-text { font-size: 14px; font-weight: 500; line-height: 1.4; flex: 1; }
  .question-meta { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
  .badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; }
  .badge-time { background: rgba(245,158,11,0.15); color: var(--accent3); border: 1px solid rgba(245,158,11,0.25); }
  .badge-answers { background: rgba(6,182,212,0.12); color: var(--accent2); border: 1px solid rgba(6,182,212,0.2); }
  .badge-type { background: rgba(124,58,237,0.12); color: #a78bfa; border: 1px solid rgba(124,58,237,0.2); }
  .question-actions { display: flex; gap: 6px; flex-shrink: 0; }
  .empty-state { text-align: center; padding: 48px 24px; color: var(--muted); border: 2px dashed var(--border); border-radius: 12px; }
  .empty-state .icon { font-size: 40px; margin-bottom: 12px; }
  .empty-state p { font-size: 14px; }

  /* Editor */
  .editor-card { position: sticky; top: 90px; }
  .options-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
  .option-row { display: flex; gap: 8px; align-items: center; }
  .option-row .input { flex: 1; }
  .correct-toggle {
    width: 36px; height: 36px; border-radius: 8px; border: 2px solid var(--border);
    background: transparent; cursor: pointer; font-size: 16px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; flex-shrink: 0;
  }
  .correct-toggle.checked { border-color: var(--success); background: rgba(16,185,129,0.15); }

  /* MANAGE */
  #page-manage { padding: 0; }
  .manage-body { padding: 32px; max-width: 960px; margin: 0 auto; flex: 1; }
  .tests-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; margin-top: 20px; }
  .test-manage-card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 20px; transition: all 0.2s; }
  .test-manage-card:hover { box-shadow: 0 8px 24px rgba(0,0,0,0.2); }
  .tmcard-title { font-family: 'Unbounded', sans-serif; font-size: 15px; font-weight: 700; margin-bottom: 8px; line-height: 1.3; }
  .tmcard-meta { font-size: 13px; color: var(--muted); margin-bottom: 16px; }
  .tmcard-actions { display: flex; gap: 8px; flex-wrap: wrap; }

  /* TEST PAGE */
  #page-test { padding: 0; }
  #test-selector { padding: 32px 20px; max-width: 800px; margin: 0 auto; width: 100%; }
  .test-cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; margin-top: 20px; }
  .test-card-item {
    background: var(--card); border: 1px solid var(--border); border-radius: 14px;
    padding: 20px; cursor: pointer; transition: all 0.2s;
  }
  .test-card-item:hover { border-color: var(--accent2); transform: translateY(-2px); box-shadow: 0 12px 32px rgba(0,0,0,0.3); }
  .test-card-title { font-family: 'Unbounded', sans-serif; font-size: 15px; font-weight: 700; margin-bottom: 8px; }
  .test-card-meta { font-size: 13px; color: var(--muted); }
  #test-start { text-align: center; padding: 60px 20px; }
  .start-title { font-family: 'Unbounded', sans-serif; font-size: 28px; font-weight: 800; letter-spacing: -1px; margin-bottom: 12px; }
  .start-info { display: flex; gap: 24px; justify-content: center; flex-wrap: wrap; margin: 24px 0; }
  .info-item { display: flex; flex-direction: column; align-items: center; }
  .info-val { font-family: 'Unbounded', sans-serif; font-size: 22px; font-weight: 700; color: var(--accent2); }
  .info-lbl { font-size: 12px; color: var(--muted); margin-top: 4px; }

  /* Question */
  #test-question { display: none; }
  .progress-bar-wrap { margin-bottom: 24px; }
  .progress-meta { display: flex; justify-content: space-between; font-size: 13px; color: var(--muted); margin-bottom: 8px; }
  .progress-bar { height: 6px; background: var(--card); border-radius: 10px; overflow: hidden; }
  .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); border-radius: 10px; transition: width 0.4s ease; }
  .timer-display {
    display: inline-flex; align-items: center; gap: 8px;
    background: rgba(245,158,11,0.12); border: 1px solid rgba(245,158,11,0.25);
    color: var(--accent3); border-radius: 10px; padding: 8px 16px;
    font-family: 'Unbounded', sans-serif; font-size: 16px; font-weight: 700;
    margin-bottom: 20px; transition: all 0.3s;
  }
  .timer-display.danger { background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.35); color: var(--danger); animation: pulse 0.8s infinite; }
  .question-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 28px; margin-bottom: 20px; }
  .q-label { font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); margin-bottom: 12px; }
  .q-text { font-size: 18px; font-weight: 600; line-height: 1.5; }
  .options-grid { display: flex; flex-direction: column; gap: 10px; }
  .option-btn {
    display: flex; align-items: center; gap: 14px;
    background: var(--card); border: 2px solid var(--border); border-radius: 12px;
    padding: 14px 18px; cursor: pointer; transition: all 0.2s; text-align: left;
    font-family: 'Manrope', sans-serif; font-size: 15px; color: var(--text); width: 100%;
  }
  .option-btn:hover:not(:disabled) { border-color: var(--accent); background: rgba(124,58,237,0.08); }
  .option-btn.selected { border-color: var(--accent); background: rgba(124,58,237,0.12); }
  .option-btn.selected .opt-letter { background: var(--accent); color: #fff; }
  .option-btn.correct { border-color: var(--success); background: rgba(16,185,129,0.1); }
  .option-btn.wrong { border-color: var(--danger); background: rgba(239,68,68,0.1); }
  .option-btn:disabled { cursor: not-allowed; opacity: 0.8; }
  .opt-letter {
    width: 32px; height: 32px; border-radius: 8px; background: var(--surface);
    border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    font-family: 'Unbounded', sans-serif; font-size: 11px; font-weight: 700;
    flex-shrink: 0; transition: all 0.2s;
  }
  .text-answer-wrap { display: flex; gap: 12px; align-items: flex-start; }
  .text-answer-wrap .textarea { flex: 1; }
  .q-nav { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; }

  /* Results */
  #test-results { display: none; text-align: center; padding: 40px 20px; }
  .result-circle {
    width: 140px; height: 140px; border-radius: 50%; margin: 0 auto 24px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    border: 4px solid var(--accent);
    background: radial-gradient(circle, rgba(124,58,237,0.1), transparent);
  }
  .result-percent { font-family: 'Unbounded', sans-serif; font-size: 32px; font-weight: 800; }
  .result-label { font-size: 11px; color: var(--muted); margin-top: 2px; }
  .result-title { font-family: 'Unbounded', sans-serif; font-size: 24px; font-weight: 800; margin-bottom: 8px; letter-spacing: -1px; }
  .result-sub { color: var(--muted); font-size: 15px; margin-bottom: 28px; }
  .result-stats { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-bottom: 32px; }
  .result-stat { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px 24px; text-align: center; }
  .result-stat-val { font-family: 'Unbounded', sans-serif; font-size: 22px; font-weight: 700; }
  .result-stat-lbl { font-size: 12px; color: var(--muted); margin-top: 4px; }

  /* MODAL */
  .modal-overlay {
    display: none; position: fixed; inset: 0; z-index: 1000;
    background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
    align-items: center; justify-content: center; padding: 20px;
  }
  .modal-overlay.active { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 32px; width: 100%; max-width: 480px; }
  .modal h3 { font-family: 'Unbounded', sans-serif; font-size: 18px; font-weight: 700; margin-bottom: 20px; }
  .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

  /* TOAST */
  .toast-container { position: fixed; top: 24px; right: 24px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; }
  .toast {
    background: var(--card); border: 1px solid var(--border); border-radius: 12px;
    padding: 12px 20px; font-size: 14px; font-weight: 500;
    display: flex; align-items: center; gap: 10px;
    animation: slideInRight 0.3s ease; min-width: 240px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    transition: opacity 0.4s;
  }
  .toast.success { border-color: rgba(16,185,129,0.4); }
  .toast.error { border-color: rgba(239,68,68,0.4); }

  /* Loading spinner */
  .spinner {
    width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.2);
    border-top-color: #fff; border-radius: 50%;
    animation: spin 0.7s linear infinite; display: inline-block;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Firebase status badge */
  .fb-status {
    display: inline-flex; align-items: center; gap: 6px;
    font-size: 11px; padding: 4px 10px; border-radius: 20px;
    font-weight: 600;
  }
  .fb-status.connected { background: rgba(16,185,129,0.15); color: var(--success); border: 1px solid rgba(16,185,129,0.3); }
  .fb-status.demo { background: rgba(245,158,11,0.15); color: var(--accent3); border: 1px solid rgba(245,158,11,0.3); }

  /* ANTI-CHEAT */
  #anticheat-overlay {
    display:none; position:fixed; inset:0; z-index:9000;
    background:rgba(0,0,0,0.97); backdrop-filter:blur(20px);
    align-items:center; justify-content:center;
    flex-direction:column; text-align:center; padding:32px;
  }

  /* ANIMATIONS */
  @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
  @keyframes slideInRight { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: translateX(0); } }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }

  @media(max-width: 768px) {
    .admin-grid { grid-template-columns: 1fr; }
    .editor-card { position: static; }
    .nav { padding: 14px 16px; flex-wrap: wrap; gap: 10px; }
    .admin-body, .manage-body { padding: 16px; }
    .nav-tab { padding: 8px 12px; font-size: 13px; }
  }
  .divider { height: 1px; background: var(--border); margin: 20px 0; }
</style>
</head>
<body>

<!-- NAV -->
<nav class="nav" id="main-nav" style="display:none">
  <div style="display:flex;align-items:center;gap:12px;">
    <div class="nav-logo">‚ö° TestMaster</div>
    <span class="fb-status" id="fb-status-badge">‚è≥ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è</span>
  </div>
  <div class="nav-tabs">
    <button class="nav-tab" onclick="showPage('home')">üè† –ì–æ–ª–æ–≤–Ω–∞</button>
    <button class="nav-tab" id="nav-tab-admin" onclick="showPage('admin')" style="display:none">‚öôÔ∏è –ê–¥–º—ñ–Ω–∫–∞</button>
    <button class="nav-tab" id="nav-tab-manage" onclick="showPage('manage')" style="display:none">üìã –¢–µ—Å—Ç–∏</button>
    <button class="nav-tab" onclick="showPage('test')">üéØ –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç</button>
  </div>
  <div class="nav-right">
    <div class="nav-user">
      <div class="nav-avatar" id="nav-avatar">?</div>
      <span id="nav-user-name" style="font-size:13px;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></span>
    </div>
    <button class="btn btn-ghost btn-sm" onclick="doLogout()">–í–∏–π—Ç–∏</button>
  </div>
</nav>

<div class="toast-container" id="toasts"></div>

<!-- ============ LOGIN PAGE ============ -->
<div class="page active" id="page-login">
  <div class="auth-wrap">
    <div class="auth-box">
      <div class="auth-logo">‚ö° TestMaster</div>
      <p class="auth-sub">–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –æ–Ω–ª–∞–π–Ω —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è</p>
      <div class="card">
        <h3 style="font-family:'Unbounded',sans-serif;font-size:16px;font-weight:700;margin-bottom:20px;">–í—Ö—ñ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
        <div class="form-group">
          <label class="form-label">Email</label>
          <div class="input-icon">
            <span class="icon">‚úâÔ∏è</span>
            <input class="input" id="login-email" type="email" placeholder="your@email.com" />
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
          <div class="input-icon">
            <span class="icon">üîí</span>
            <input class="input" id="login-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              onkeydown="if(event.key==='Enter')doLogin()" />
          </div>
        </div>
        <div id="login-error" style="color:var(--danger);font-size:13px;margin-bottom:12px;display:none;"></div>
        <button class="btn btn-primary" id="login-btn" style="width:100%;justify-content:center;" onclick="doLogin()">
          –£–≤—ñ–π—Ç–∏ ‚Üí
        </button>
        <div class="divider-text">–∞–±–æ</div>
        <button class="btn btn-secondary" style="width:100%;justify-content:center;" onclick="doDemoLogin()">
          üöÄ –£–≤—ñ–π—Ç–∏ —è–∫ –¥–µ–º–æ-–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á
        </button>
        <div class="auth-switch">–ù–µ–º–∞—î –∞–∫–∞—É–Ω—Ç—É? <a onclick="switchToRegister()">–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—å</a></div>
      </div>
    </div>
  </div>
</div>

<!-- ============ REGISTER PAGE ============ -->
<div class="page" id="page-register">
  <div class="auth-wrap">
    <div class="auth-box">
      <div class="auth-logo">‚ö° TestMaster</div>
      <p class="auth-sub">–°—Ç–≤–æ—Ä—ñ—Ç—å –∞–∫–∞—É–Ω—Ç –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ</p>
      <div class="card">
        <h3 style="font-family:'Unbounded',sans-serif;font-size:16px;font-weight:700;margin-bottom:20px;">–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h3>
        <div class="form-group">
          <label class="form-label">–Ü–º'—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ</label>
          <div class="input-icon">
            <span class="icon">üë§</span>
            <input class="input" id="reg-name" type="text" placeholder="–Ü–≤–∞–Ω–æ–≤ –Ü–≤–∞–Ω" />
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <div class="input-icon">
            <span class="icon">‚úâÔ∏è</span>
            <input class="input" id="reg-email" type="email" placeholder="your@email.com" />
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
          <div class="input-icon">
            <span class="icon">üîí</span>
            <input class="input" id="reg-pass" type="password" placeholder="–º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤"
              onkeydown="if(event.key==='Enter')doRegister()" />
          </div>
        </div>
        <div id="reg-error" style="color:var(--danger);font-size:13px;margin-bottom:12px;display:none;"></div>
        <button class="btn btn-primary" id="reg-btn" style="width:100%;justify-content:center;" onclick="doRegister()">
          –ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—å ‚Üí
        </button>
        <div class="auth-switch">–í–∂–µ —î –∞–∫–∞—É–Ω—Ç? <a onclick="switchToLogin()">–£–≤—ñ–π—Ç–∏</a></div>
      </div>
    </div>
  </div>
</div>

<!-- ============ HOME PAGE ============ -->
<div class="page" id="page-home">
  <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px 20px;text-align:center;">
    <div class="hero-badge">üöÄ –û–Ω–ª–∞–π–Ω –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è</div>
    <h1 class="hero-title">–ü–µ—Ä–µ–≤—ñ—Ä —Å–≤–æ—ó<br><span>–∑–Ω–∞–Ω–Ω—è</span></h1>
    <p class="hero-sub" id="home-welcome">–®–≤–∏–¥–∫–æ –ø—Ä–æ—Ö–æ–¥—å —Ç–µ—Å—Ç–∏ —ñ –æ—Ç—Ä–∏–º—É–π –º–∏—Ç—Ç—î–≤—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏.</p>
    <div class="hero-actions">
      <button class="btn btn-primary btn-lg" onclick="showPage('test')">üéØ –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç</button>
      <button class="btn btn-secondary btn-lg" id="home-admin-btn" onclick="showPage('admin')" style="display:none">‚öôÔ∏è –ê–¥–º—ñ–Ω–∫–∞</button>
    </div>
    <div class="hero-stats" id="home-stats">
      <div class="stat"><div class="stat-num" id="stat-tests">0</div><div class="stat-label">–¢–µ—Å—Ç—ñ–≤</div></div>
      <div class="stat"><div class="stat-num" id="stat-questions">0</div><div class="stat-label">–ü–∏—Ç–∞–Ω—å</div></div>
      <div class="stat"><div class="stat-num" id="stat-results">0</div><div class="stat-label">–†–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤</div></div>
    </div>
  </div>
</div>

<!-- ============ ADMIN PAGE ============ -->
<div class="page" id="page-admin">
  <div class="admin-body">
    <div class="page-header">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
        <div>
          <div class="page-title">‚öôÔ∏è –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è</div>
          <div class="page-sub">–†–µ–¥–∞–∫—Ç–æ—Ä –ø–∏—Ç–∞–Ω—å —Ç–∞ —Ç–µ—Å—Ç—ñ–≤</div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <select class="select" id="admin-test-select" style="width:auto;min-width:180px;" onchange="loadTestInAdmin()">
            <option value="">‚Äî –û–±–µ—Ä–∏ —Ç–µ—Å—Ç ‚Äî</option>
          </select>
          <button class="btn btn-cyan" onclick="openCreateTest()">+ –ù–æ–≤–∏–π —Ç–µ—Å—Ç</button>
        </div>
      </div>
    </div>
    <div class="admin-grid">
      <div>
        <div class="section-title">–ü–∏—Ç–∞–Ω–Ω—è —Ç–µ—Å—Ç—É</div>
        <div class="question-list" id="question-list">
          <div class="empty-state"><div class="icon">üìù</div><p>–û–±–µ—Ä–∏ –∞–±–æ —Å—Ç–≤–æ—Ä–∏ —Ç–µ—Å—Ç</p></div>
        </div>
      </div>
      <div>
        <div class="card editor-card">
          <div class="section-title">–†–µ–¥–∞–∫—Ç–æ—Ä –ø–∏—Ç–∞–Ω–Ω—è</div>
          <div class="form-group">
            <label class="form-label">–¢–µ–∫—Å—Ç –ø–∏—Ç–∞–Ω–Ω—è *</label>
            <textarea class="textarea" id="q-text" placeholder="–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç –ø–∏—Ç–∞–Ω–Ω—è..."></textarea>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div class="form-group">
              <label class="form-label">–¢–∏–ø</label>
              <select class="select" id="q-type" onchange="renderOptionsEditor()">
                <option value="single">–û–¥–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</option>
                <option value="multiple">–ö—ñ–ª—å–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π</option>
                <option value="text">–¢–µ–∫—Å—Ç–æ–≤–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">‚è± –ß–∞—Å (—Å–µ–∫—É–Ω–¥–∏)</label>
              <input class="input" type="number" id="q-time" value="30" min="5" max="600" />
            </div>
          </div>
          <div id="options-editor"></div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;">
            <button class="btn btn-primary" onclick="saveQuestion()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
            <button class="btn btn-secondary" onclick="clearEditor()">‚úï –û—á–∏—Å—Ç–∏—Ç–∏</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ============ MANAGE PAGE ============ -->
<div class="page" id="page-manage">
  <div class="manage-body">
    <div class="page-header">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
        <div>
          <div class="page-title">üìã –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç–µ—Å—Ç–∞–º–∏</div>
          <div class="page-sub">–í—Å—ñ —Ç–µ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º–∏</div>
        </div>
        <button class="btn btn-cyan" onclick="openCreateTest()">+ –°—Ç–≤–æ—Ä–∏—Ç–∏ —Ç–µ—Å—Ç</button>
      </div>
    </div>
    <div class="tests-grid" id="tests-grid">
      <div class="empty-state" style="grid-column:1/-1"><div class="icon">üìã</div><p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</p></div>
    </div>
    <div style="margin-top:40px;">
      <div class="section-title">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ç–µ—Å—Ç—É–≤–∞–Ω—å</div>
      <div id="results-table" style="margin-top:12px;"></div>
    </div>
  </div>
</div>

<!-- ============ TEST PAGE ============ -->
<div class="page" id="page-test">
  <div id="test-selector">
    <div style="max-width:800px;margin:0 auto;padding:32px 20px;">
      <div class="page-title">üéØ –ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç</div>
      <p style="color:var(--muted);font-size:14px;margin-top:4px;margin-bottom:20px;">–û–±–µ—Ä–∏ —Ç–µ—Å—Ç –¥–ª—è –ø—Ä–æ—Ö–æ–¥–∂–µ–Ω–Ω—è</p>
      <div class="test-cards-grid" id="test-cards"></div>
    </div>
  </div>

  <div id="test-start" style="display:none;text-align:center;padding:60px 20px;">
    <div class="start-title" id="start-test-title"></div>
    <div id="start-test-desc" style="color:var(--muted);margin-bottom:20px;font-size:15px;"></div>
    <div style="
      display:inline-flex;align-items:flex-start;gap:10px;text-align:left;
      background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.25);
      border-radius:12px;padding:14px 18px;margin-bottom:24px;max-width:480px;
      font-size:13px;color:#f87171;line-height:1.6;">
      <span style="font-size:18px;flex-shrink:0;">üõ°Ô∏è</span>
      <span><strong style="color:#ef4444;">–ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ —Å–ø–∏—Å—É–≤–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–∏–π.</strong><br>
      –¢–µ—Å—Ç –∑—É–ø–∏–Ω–∏—Ç—å—Å—è —è–∫—â–æ –≤–∏: –∑–≥–æ—Ä–Ω–µ—Ç–µ –≤—ñ–∫–Ω–æ, –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ –≤–∫–ª–∞–¥–∫—É –∞–±–æ –∑–º—ñ–Ω–µ—Ç–µ —Ä–æ–∑–º—ñ—Ä –≤—ñ–∫–Ω–∞.
      –î–æ–∑–≤–æ–ª–µ–Ω–æ <strong>3 –ø–æ—Ä—É—à–µ–Ω–Ω—è</strong>, –ø—ñ—Å–ª—è —á–æ–≥–æ —Ç–µ—Å—Ç –∞–Ω—É–ª—é—î—Ç—å—Å—è.</span>
    </div>
    <div class="start-info">
      <div class="info-item"><div class="info-val" id="start-q-count">0</div><div class="info-lbl">–ü–∏—Ç–∞–Ω—å</div></div>
      <div class="info-item"><div class="info-val" id="start-avg-time">0—Å</div><div class="info-lbl">–°–µ—Ä. —á–∞—Å</div></div>
    </div>
    <button class="btn btn-primary btn-lg" onclick="beginTest()">üöÄ –ü–æ—á–∞—Ç–∏!</button>
    <div style="margin-top:16px;">
      <button class="btn btn-ghost btn-sm" onclick="initTestPage()">‚Üê –ù–∞–∑–∞–¥</button>
    </div>
  </div>

  <div id="test-question" style="max-width:720px;margin:0 auto;width:100%;padding:24px;">
    <div class="progress-bar-wrap">
      <div class="progress-meta">
        <span id="q-progress-text">–ü–∏—Ç–∞–Ω–Ω—è 1 –∑ 10</span>
        <span id="q-score-text">0 –±–∞–ª—ñ–≤</span>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
    </div>
    <div class="timer-display" id="timer-display">‚è± 30—Å</div>
    <div class="question-card">
      <div class="q-label" id="q-type-label">–ü–ò–¢–ê–ù–ù–Ø</div>
      <div class="q-text" id="current-q-text"></div>
    </div>
    <div id="current-options"></div>
    <div class="q-nav">
      <div id="q-feedback" style="font-size:14px;font-weight:600;"></div>
      <button class="btn btn-primary" id="next-btn" onclick="nextQuestion()" style="display:none;">–ù–∞—Å—Ç—É–ø–Ω–µ ‚Üí</button>
    </div>
  </div>

  <div id="test-results" style="display:none;max-width:600px;margin:0 auto;width:100%;padding:24px;text-align:center;">
    <div class="result-circle">
      <div class="result-percent" id="res-percent">0%</div>
      <div class="result-label">—Ä–µ–∑—É–ª—å—Ç–∞—Ç</div>
    </div>
    <div class="result-title" id="res-title">–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–æ!</div>
    <div class="result-sub" id="res-sub"></div>
    <div class="result-stats">
      <div class="result-stat"><div class="result-stat-val" id="res-correct" style="color:var(--success)">0</div><div class="result-stat-lbl">–ü—Ä–∞–≤–∏–ª—å–Ω–∏—Ö</div></div>
      <div class="result-stat"><div class="result-stat-val" id="res-wrong" style="color:var(--danger)">0</div><div class="result-stat-lbl">–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏—Ö</div></div>
      <div class="result-stat"><div class="result-stat-val" id="res-time">0—Å</div><div class="result-stat-lbl">–ß–∞—Å</div></div>
    </div>
    <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
      <button class="btn btn-secondary btn-lg" onclick="initTestPage()">‚Üê –Ü–Ω—à–∏–π —Ç–µ—Å—Ç</button>
      <button class="btn btn-primary btn-lg" onclick="retakeTest()">üîÑ –ü—Ä–æ–π—Ç–∏ –∑–Ω–æ–≤—É</button>
    </div>
  </div>
</div>

<!-- ANTI-CHEAT OVERLAY -->
<div id="anticheat-overlay" style="display:none;position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,0.97);backdrop-filter:blur(20px);align-items:center;justify-content:center;flex-direction:column;text-align:center;padding:32px;">
  <div style="max-width:440px;background:#16161f;border:2px solid #ef4444;border-radius:20px;padding:40px 36px;box-shadow:0 0 60px rgba(239,68,68,0.3);">
    <div style="font-size:52px;margin-bottom:16px;" id="ac-icon">üö®</div>
    <div style="font-family:'Unbounded',sans-serif;font-size:20px;font-weight:800;color:#ef4444;margin-bottom:12px;" id="ac-title">–ü–æ—Ä—É—à–µ–Ω–Ω—è –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ!</div>
    <div style="color:#6b6b80;font-size:14px;line-height:1.6;margin-bottom:8px;" id="ac-reason"></div>
    <div style="display:inline-flex;align-items:center;gap:8px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;padding:8px 16px;margin:16px 0;font-family:'Unbounded',sans-serif;font-size:13px;font-weight:700;color:#ef4444;" id="ac-violations-badge"></div>
    <div style="color:#6b6b80;font-size:12px;margin-bottom:24px;" id="ac-warning"></div>
    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;" id="ac-actions"></div>
  </div>
</div>

<!-- MODAL: CREATE TEST -->
<div class="modal-overlay" id="modal-create-test">
  <div class="modal">
    <h3>üìã –ù–æ–≤–∏–π —Ç–µ—Å—Ç</h3>
    <div class="form-group">
      <label class="form-label">–ù–∞–∑–≤–∞ —Ç–µ—Å—Ç—É *</label>
      <input class="input" id="new-test-name" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞. –¢–µ–º–∞ 1" />
    </div>
    <div class="form-group">
      <label class="form-label">–û–ø–∏—Å</label>
      <textarea class="textarea" id="new-test-desc" placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å —Ç–µ—Å—Ç—É..."></textarea>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal('modal-create-test')">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      <button class="btn btn-primary" onclick="createTest()">–°—Ç–≤–æ—Ä–∏—Ç–∏ ‚Üí</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// CONFIG
// ============================================================
const _adminEmail = 'admin@testmaster.com'; // ‚Üê –ó–º—ñ–Ω–∏—Ç–∏ –Ω–∞ email –∞–¥–º—ñ–Ω–∞
window._adminEmail = _adminEmail;

// ============================================================
// STATE
// ============================================================
let state = {
  tests: [],
  results: [],
  currentTestId: null,
  editingQIdx: null,
  sessionTest: null,
  sessionStudent: '',
  sessionAnswers: [],
  sessionCurrent: 0,
  sessionScore: 0,
  sessionTimer: null,
  sessionStartTime: null,
  sessionCorrect: 0,
  sessionWrong: 0,
  acViolations: 0,
  acMaxViolations: 3,
  acActive: false,
  useFirebase: false
};

// ============================================================
// FIREBASE HELPERS
// ============================================================
function fb() { return window._fb; }
function fbUser() { return window._fbUser; }
function isAdmin() { return fbUser()?.email === _adminEmail; }

async function loadFromFirebase() {
  try {
    const { db, collection, getDocs, query, orderBy } = fb();

    // Load tests
    const testsSnap = await getDocs(collection(db, 'tests'));
    state.tests = [];
    testsSnap.forEach(docSnap => {
      state.tests.push({ id: docSnap.id, ...docSnap.data() });
    });

    // Load results
    const resSnap = await getDocs(collection(db, 'results'));
    state.results = [];
    resSnap.forEach(docSnap => {
      state.results.push({ id: docSnap.id, ...docSnap.data() });
    });

    state.useFirebase = true;
    setBadge('connected', 'üî• Firebase');

    // Seed demo test if no tests exist and user is admin
    if (state.tests.length === 0 && isAdmin()) await seedDemoFirebase();

    console.log('Firebase loaded:', state.tests.length, 'tests,', state.results.length, 'results');
  } catch (e) {
    console.warn('Firebase load failed, using localStorage:', e.message);
    state.useFirebase = false;
    setBadge('demo', 'üíæ –õ–æ–∫–∞–ª—å–Ω–æ');
    loadLocal();
  }
}

async function saveTestToFirebase(test) {
  try {
    const { db, doc, setDoc } = fb();
    await setDoc(doc(db, 'tests', test.id), test);
  } catch (e) {
    console.error('Save test error:', e);
    toast('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ç–µ—Å—Ç—É', 'error');
  }
}

async function deleteTestFromFirebase(id) {
  try {
    const { db, doc, deleteDoc } = fb();
    await deleteDoc(doc(db, 'tests', id));
  } catch (e) {
    console.error('Delete test error:', e);
  }
}

async function saveResultToFirebase(result) {
  try {
    const { db, collection, addDoc, serverTimestamp } = fb();
    await addDoc(collection(db, 'results'), { ...result, createdAt: serverTimestamp() });
  } catch (e) {
    console.error('Save result error:', e);
  }
}

async function seedDemoFirebase() {
  const demo = {
    id: 'demo1',
    name: '–î–µ–º–æ: –ó–∞–≥–∞–ª—å–Ω—ñ –∑–Ω–∞–Ω–Ω—è',
    desc: '–¢–µ—Å—Ç –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—ó –º–æ–∂–ª–∏–≤–æ—Å—Ç–µ–π —Å–∏—Å—Ç–µ–º–∏',
    questions: [
      { id: 'q1', text: '–Ø–∫–∞ —Å—Ç–æ–ª–∏—Ü—è –£–∫—Ä–∞—ó–Ω–∏?', type: 'single', time: 20, options: ['–ö–∏—ó–≤','–•–∞—Ä–∫—ñ–≤','–õ—å–≤—ñ–≤','–û–¥–µ—Å–∞'], correct: [0] },
      { id: 'q2', text: '–°–∫—ñ–ª—å–∫–∏ –º—ñ—Å—è—Ü—ñ–≤ –≤ —Ä–æ—Ü—ñ?', type: 'single', time: 15, options: ['10','11','12','13'], correct: [2] },
      { id: 'q3', text: '–Ø–∫—ñ –ø–ª–∞–Ω–µ—Ç–∏ —î –≥–∞–∑–æ–≤–∏–º–∏ –≥—ñ–≥–∞–Ω—Ç–∞–º–∏? (–∫—ñ–ª—å–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π)', type: 'multiple', time: 40, options: ['–ó–µ–º–ª—è','–Æ–ø—ñ—Ç–µ—Ä','–°–∞—Ç—É—Ä–Ω','–ú–∞—Ä—Å'], correct: [1,2] },
      { id: 'q4', text: '–ù–∞–ø–∏—à—ñ—Ç—å —Å—Ç–æ–ª–∏—Ü—é –§—Ä–∞–Ω—Ü—ñ—ó', type: 'text', time: 25, options: [], correct: [], answer: '–ø–∞—Ä–∏–∂' }
    ]
  };
  state.tests.push(demo);
  await saveTestToFirebase(demo);
}

function setBadge(type, text) {
  const badge = document.getElementById('fb-status-badge');
  badge.className = 'fb-status ' + type;
  badge.textContent = text;
}

// ============================================================
// LOCAL STORAGE FALLBACK
// ============================================================
function saveLocal() {
  localStorage.setItem('tm_tests', JSON.stringify(state.tests));
  localStorage.setItem('tm_results', JSON.stringify(state.results));
}
function loadLocal() {
  try { state.tests = JSON.parse(localStorage.getItem('tm_tests') || '[]'); } catch(e) { state.tests = []; }
  try { state.results = JSON.parse(localStorage.getItem('tm_results') || '[]'); } catch(e) { state.results = []; }
  if (!state.tests.length) seedDemoLocal();
}
function seedDemoLocal() {
  state.tests.push({
    id: 'demo1', name: '–î–µ–º–æ: –ó–∞–≥–∞–ª—å–Ω—ñ –∑–Ω–∞–Ω–Ω—è', desc: '–¢–µ—Å—Ç –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—ó –º–æ–∂–ª–∏–≤–æ—Å—Ç–µ–π —Å–∏—Å—Ç–µ–º–∏',
    questions: [
      { id: 'q1', text: '–Ø–∫–∞ —Å—Ç–æ–ª–∏—Ü—è –£–∫—Ä–∞—ó–Ω–∏?', type: 'single', time: 20, options: ['–ö–∏—ó–≤','–•–∞—Ä–∫—ñ–≤','–õ—å–≤—ñ–≤','–û–¥–µ—Å–∞'], correct: [0] },
      { id: 'q2', text: '–°–∫—ñ–ª—å–∫–∏ –º—ñ—Å—è—Ü—ñ–≤ –≤ —Ä–æ—Ü—ñ?', type: 'single', time: 15, options: ['10','11','12','13'], correct: [2] },
      { id: 'q3', text: '–Ø–∫—ñ –ø–ª–∞–Ω–µ—Ç–∏ —î –≥–∞–∑–æ–≤–∏–º–∏ –≥—ñ–≥–∞–Ω—Ç–∞–º–∏? (–∫—ñ–ª—å–∫–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π)', type: 'multiple', time: 40, options: ['–ó–µ–º–ª—è','–Æ–ø—ñ—Ç–µ—Ä','–°–∞—Ç—É—Ä–Ω','–ú–∞—Ä—Å'], correct: [1,2] },
      { id: 'q4', text: '–ù–∞–ø–∏—à—ñ—Ç—å —Å—Ç–æ–ª–∏—Ü—é –§—Ä–∞–Ω—Ü—ñ—ó', type: 'text', time: 25, options: [], correct: [], answer: '–ø–∞—Ä–∏–∂' }
    ]
  });
  saveLocal();
}
async function save() {
  if (state.useFirebase) {
    // Firebase saves happen per-operation; local is backup
  }
  saveLocal();
}

// ============================================================
// AUTH
// ============================================================
async function doLogin() {
  const email = document.getElementById('login-email').value.trim();
  const pass = document.getElementById('login-pass').value;
  const errEl = document.getElementById('login-error');
  const btn = document.getElementById('login-btn');

  if (!email || !pass) { showAuthError('login-error', '–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è'); return; }
  errEl.style.display = 'none';
  btn.innerHTML = '<span class="spinner"></span> –í—Ö—ñ–¥...';
  btn.disabled = true;

  try {
    const { auth, signInWithEmailAndPassword } = fb();
    await signInWithEmailAndPassword(auth, email, pass);
    // onAuthStateChanged handles the rest
  } catch (e) {
    btn.innerHTML = '–£–≤—ñ–π—Ç–∏ ‚Üí'; btn.disabled = false;
    const msg = e.code === 'auth/invalid-credential' || e.code === 'auth/wrong-password' || e.code === 'auth/user-not-found'
      ? '–ù–µ–≤—ñ—Ä–Ω–∏–π email –∞–±–æ –ø–∞—Ä–æ–ª—å' : '–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É: ' + e.message;
    showAuthError('login-error', msg);
  }
}

async function doRegister() {
  const name = document.getElementById('reg-name').value.trim();
  const email = document.getElementById('reg-email').value.trim();
  const pass = document.getElementById('reg-pass').value;
  const btn = document.getElementById('reg-btn');

  if (!name || !email || !pass) { showAuthError('reg-error', '–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è'); return; }
  if (pass.length < 6) { showAuthError('reg-error', '–ü–∞—Ä–æ–ª—å ‚Äî –º—ñ–Ω—ñ–º—É–º 6 —Å–∏–º–≤–æ–ª—ñ–≤'); return; }

  btn.innerHTML = '<span class="spinner"></span> –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è...';
  btn.disabled = true;

  try {
    const { auth, createUserWithEmailAndPassword, updateProfile } = fb();
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    await updateProfile(cred.user, { displayName: name });
    toast('–ê–∫–∞—É–Ω—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ! –õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ üéâ', 'success');
  } catch (e) {
    btn.innerHTML = '–ó–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—å ‚Üí'; btn.disabled = false;
    const msg = e.code === 'auth/email-already-in-use'
      ? '–¶–µ–π email –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è'
      : e.code === 'auth/invalid-email' ? '–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç email'
      : '–ü–æ–º–∏–ª–∫–∞: ' + e.message;
    showAuthError('reg-error', msg);
  }
}

async function doDemoLogin() {
  // Demo mode ‚Äî fake local user without Firebase
  state.useFirebase = false;
  setBadge('demo', 'üíæ –î–µ–º–æ —Ä–µ–∂–∏–º');
  loadLocal();
  document.getElementById('page-login').classList.remove('active');
  document.getElementById('main-nav').style.display = 'flex';
  document.getElementById('nav-user-name').textContent = '–î–µ–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á';
  document.getElementById('nav-avatar').textContent = '–î';
  document.getElementById('nav-tab-admin').style.display = 'none';
  document.getElementById('nav-tab-manage').style.display = 'none';
  showPage('home');
  toast('–î–µ–º–æ —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ üöÄ', 'success');
}

async function doLogout() {
  try {
    if (state.useFirebase && fb()?.auth) {
      await fb().auth.signOut?.() || fb().signOut(fb().auth);
    }
  } catch(e) {}
  window._fbUser = null;
  window._appReady = false;
  state.useFirebase = false;
  document.getElementById('main-nav').style.display = 'none';
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('page-login').classList.add('active');
  document.getElementById('login-email').value = '';
  document.getElementById('login-pass').value = '';
  toast('–í–∏ –≤–∏–π—à–ª–∏ —ñ–∑ —Å–∏—Å—Ç–µ–º–∏', 'success');
}

function showAuthError(id, msg) {
  const el = document.getElementById(id);
  el.textContent = msg;
  el.style.display = 'block';
}

function switchToRegister() {
  document.getElementById('page-login').classList.remove('active');
  document.getElementById('page-register').classList.add('active');
  document.getElementById('reg-error').style.display = 'none';
}
function switchToLogin() {
  document.getElementById('page-register').classList.remove('active');
  document.getElementById('page-login').classList.add('active');
  document.getElementById('login-error').style.display = 'none';
}

// ============================================================
// NAVIGATION
// ============================================================
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + name)?.classList.add('active');

  const tabs = document.querySelectorAll('.nav-tab:not(#nav-tab-admin):not(#nav-tab-manage)');
  const adminTab = document.getElementById('nav-tab-admin');
  const manageTab = document.getElementById('nav-tab-manage');
  const allTabs = document.querySelectorAll('.nav-tab');
  allTabs.forEach(t => t.classList.remove('active'));

  const map = { home: 0, test: 1 };
  if (name === 'admin' && adminTab) adminTab.classList.add('active');
  else if (name === 'manage' && manageTab) manageTab.classList.add('active');
  else {
    // home=0, test=last visible
    if (name === 'home') tabs[0]?.classList.add('active');
    if (name === 'test') tabs[tabs.length - 1]?.classList.add('active');
  }

  // Update nav avatar
  const user = fbUser();
  if (user) {
    const initials = (user.displayName || user.email || '?').substring(0, 1).toUpperCase();
    document.getElementById('nav-avatar').textContent = initials;
    document.getElementById('nav-user-name').textContent = user.displayName || user.email;
  }

  // Admin tabs visibility
  const admin = isAdmin() || (state.useFirebase === false && !window._fbUser);
  document.getElementById('home-admin-btn').style.display = isAdmin() ? '' : 'none';

  if (name === 'home') updateHomeStats();
  if (name === 'admin') { if (!isAdmin() && state.useFirebase) { toast('–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ', 'error'); showPage('home'); return; } initAdmin(); }
  if (name === 'manage') { if (!isAdmin() && state.useFirebase) { toast('–î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ', 'error'); showPage('home'); return; } renderManage(); }
  if (name === 'test') initTestPage();
}

// ============================================================
// HOME
// ============================================================
function updateHomeStats() {
  document.getElementById('stat-tests').textContent = state.tests.length;
  const totalQ = state.tests.reduce((s, t) => s + (t.questions?.length || 0), 0);
  document.getElementById('stat-questions').textContent = totalQ;
  document.getElementById('stat-results').textContent = state.results.length;

  const user = fbUser();
  if (user?.displayName) {
    document.getElementById('home-welcome').textContent = `–ü—Ä–∏–≤—ñ—Ç, ${user.displayName}! –ì–æ—Ç–æ–≤–∏–π –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å–≤–æ—ó –∑–Ω–∞–Ω–Ω—è?`;
  }
  document.getElementById('home-admin-btn').style.display = isAdmin() ? '' : 'none';
}

// ============================================================
// ADMIN
// ============================================================
function initAdmin() {
  renderAdminTestSelect();
  renderOptionsEditor();
}
function renderAdminTestSelect() {
  const sel = document.getElementById('admin-test-select');
  const cur = sel.value;
  sel.innerHTML = '<option value="">‚Äî –û–±–µ—Ä–∏ —Ç–µ—Å—Ç ‚Äî</option>';
  state.tests.forEach(t => {
    const o = document.createElement('option');
    o.value = t.id; o.textContent = t.name;
    if (t.id === cur || t.id === state.currentTestId) o.selected = true;
    sel.appendChild(o);
  });
}
function loadTestInAdmin() {
  state.currentTestId = document.getElementById('admin-test-select').value;
  renderQuestionList();
  clearEditor();
}
function renderQuestionList() {
  const list = document.getElementById('question-list');
  const test = state.tests.find(t => t.id === state.currentTestId);
  if (!test) { list.innerHTML = '<div class="empty-state"><div class="icon">üìù</div><p>–û–±–µ—Ä–∏ –∞–±–æ —Å—Ç–≤–æ—Ä–∏ —Ç–µ—Å—Ç</p></div>'; return; }
  if (!test.questions?.length) { list.innerHTML = '<div class="empty-state"><div class="icon">‚ùì</div><p>–ù–µ–º–∞—î –ø–∏—Ç–∞–Ω—å. –î–æ–¥–∞–π—Ç–µ –ø–µ—Ä—à–µ!</p></div>'; return; }
  list.innerHTML = '';
  test.questions.forEach((q, i) => {
    const typeLabel = { single: '–û–¥–Ω–∞', multiple: '–ö—ñ–ª—å–∫–∞', text: '–¢–µ–∫—Å—Ç' }[q.type];
    const div = document.createElement('div');
    div.className = 'question-item' + (state.editingQIdx === i ? ' editing' : '');
    div.innerHTML = `
      <div class="question-item-header">
        <span class="question-num">#${i+1}</span>
        <span class="question-text">${q.text}</span>
        <div class="question-actions">
          <button class="btn btn-secondary btn-sm" onclick="editQuestion(${i})">‚úèÔ∏è</button>
          <button class="btn btn-danger btn-sm" onclick="deleteQuestion(${i})">üóë</button>
        </div>
      </div>
      <div class="question-meta">
        <span class="badge badge-time">‚è± ${q.time}—Å</span>
        <span class="badge badge-type">${typeLabel}</span>
        ${q.type !== 'text' ? `<span class="badge badge-answers">${q.options.length} –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤</span>` : ''}
      </div>`;
    list.appendChild(div);
  });
}

function renderOptionsEditor() {
  const type = document.getElementById('q-type').value;
  const wrap = document.getElementById('options-editor');
  if (type === 'text') {
    wrap.innerHTML = `<div class="form-group"><label class="form-label">–ü—Ä–∞–≤–∏–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</label><input class="input" id="text-correct" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å..." /></div>`;
    return;
  }
  wrap.innerHTML = `
    <div class="form-group">
      <label class="form-label">–í–∞—Ä—ñ–∞–Ω—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π <span style="color:var(--muted);font-weight:400;">(‚úî = –ø—Ä–∞–≤–∏–ª—å–Ω–∞)</span></label>
      <div class="options-list" id="options-list"></div>
      <button class="btn btn-secondary btn-sm" style="margin-top:8px;" onclick="addOption()">+ –î–æ–¥–∞—Ç–∏ –≤–∞—Ä—ñ–∞–Ω—Ç</button>
    </div>`;
  for (let i = 0; i < 4; i++) addOption();
}

function addOption(val = '', isCorrect = false) {
  const list = document.getElementById('options-list');
  if (!list) return;
  const idx = list.children.length;
  const letters = 'ABCDEFGHIJ';
  const row = document.createElement('div');
  row.className = 'option-row';
  row.innerHTML = `
    <span style="font-family:'Unbounded',sans-serif;font-size:11px;font-weight:700;color:var(--muted);width:20px;text-align:center;">${letters[idx]}</span>
    <input class="input" placeholder="–í–∞—Ä—ñ–∞–Ω—Ç ${letters[idx]}" value="${val.replace(/"/g,'&quot;')}" />
    <button class="correct-toggle ${isCorrect ? 'checked' : ''}" onclick="toggleCorrect(this)" title="–ü—Ä–∞–≤–∏–ª—å–Ω–∞?">‚úî</button>
    <button class="btn btn-danger btn-sm" onclick="this.parentElement.remove()" style="padding:6px 10px;">‚úï</button>`;
  list.appendChild(row);
}

function toggleCorrect(btn) {
  if (document.getElementById('q-type').value === 'single') {
    document.querySelectorAll('#options-list .correct-toggle').forEach(b => b.classList.remove('checked'));
  }
  btn.classList.toggle('checked');
}

async function saveQuestion() {
  const test = state.tests.find(t => t.id === state.currentTestId);
  if (!test) { toast('–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å —Ç–µ—Å—Ç!', 'error'); return; }
  const text = document.getElementById('q-text').value.trim();
  const type = document.getElementById('q-type').value;
  const time = parseInt(document.getElementById('q-time').value) || 30;
  if (!text) { toast('–í–≤–µ–¥—ñ—Ç—å —Ç–µ–∫—Å—Ç –ø–∏—Ç–∞–Ω–Ω—è!', 'error'); return; }

  const q = { id: 'q' + Date.now(), text, type, time, options: [], correct: [], answer: '' };

  if (type === 'text') {
    q.answer = (document.getElementById('text-correct')?.value || '').trim().toLowerCase();
  } else {
    const rows = document.querySelectorAll('#options-list .option-row');
    rows.forEach(row => {
      const val = row.querySelector('input').value.trim();
      if (val) {
        q.options.push(val);
        if (row.querySelector('.correct-toggle.checked')) q.correct.push(q.options.length - 1);
      }
    });
    if (!q.options.length) { toast('–î–æ–¥–∞–π—Ç–µ —Ö–æ—á–∞ –± –æ–¥–∏–Ω –≤–∞—Ä—ñ–∞–Ω—Ç!', 'error'); return; }
    if (!q.correct.length) { toast('–ü–æ–∑–Ω–∞—á—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å!', 'error'); return; }
  }

  if (state.editingQIdx !== null) {
    q.id = test.questions[state.editingQIdx].id;
    test.questions[state.editingQIdx] = q;
    toast('–ü–∏—Ç–∞–Ω–Ω—è –æ–Ω–æ–≤–ª–µ–Ω–æ ‚úì', 'success');
  } else {
    test.questions.push(q);
    toast('–ü–∏—Ç–∞–Ω–Ω—è –¥–æ–¥–∞–Ω–æ ‚úì', 'success');
  }

  state.editingQIdx = null;
  if (state.useFirebase) await saveTestToFirebase(test);
  saveLocal();
  renderQuestionList();
  clearEditor();
}

function editQuestion(idx) {
  const test = state.tests.find(t => t.id === state.currentTestId);
  if (!test) return;
  const q = test.questions[idx];
  state.editingQIdx = idx;
  document.getElementById('q-text').value = q.text;
  document.getElementById('q-type').value = q.type;
  document.getElementById('q-time').value = q.time;
  renderOptionsEditor();
  if (q.type === 'text') {
    document.getElementById('text-correct').value = q.answer || '';
  } else {
    document.getElementById('options-list').innerHTML = '';
    q.options.forEach((opt, i) => addOption(opt, q.correct.includes(i)));
  }
  renderQuestionList();
  document.querySelector('.editor-card')?.scrollIntoView({ behavior: 'smooth' });
}

async function deleteQuestion(idx) {
  const test = state.tests.find(t => t.id === state.currentTestId);
  if (!test) return;
  test.questions.splice(idx, 1);
  if (state.editingQIdx === idx) { state.editingQIdx = null; clearEditor(); }
  if (state.useFirebase) await saveTestToFirebase(test);
  saveLocal();
  renderQuestionList();
  toast('–ü–∏—Ç–∞–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ', 'success');
}

function clearEditor() {
  state.editingQIdx = null;
  document.getElementById('q-text').value = '';
  document.getElementById('q-type').value = 'single';
  document.getElementById('q-time').value = '30';
  renderOptionsEditor();
  renderQuestionList();
}

// ============================================================
// TESTS CRUD
// ============================================================
function openCreateTest() {
  document.getElementById('new-test-name').value = '';
  document.getElementById('new-test-desc').value = '';
  openModal('modal-create-test');
}

async function createTest() {
  const name = document.getElementById('new-test-name').value.trim();
  if (!name) { toast('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —Ç–µ—Å—Ç—É!', 'error'); return; }
  const test = { id: 'test_' + Date.now(), name, desc: document.getElementById('new-test-desc').value.trim(), questions: [] };
  state.tests.push(test);
  state.currentTestId = test.id;
  if (state.useFirebase) await saveTestToFirebase(test);
  saveLocal();
  closeModal('modal-create-test');
  toast('–¢–µ—Å—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ! ‚úì', 'success');
  renderAdminTestSelect();
  document.getElementById('admin-test-select').value = test.id;
  renderQuestionList();
  renderManage();
}

async function deleteTest(id) {
  if (!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–µ—Å—Ç?')) return;
  state.tests = state.tests.filter(t => t.id !== id);
  if (state.currentTestId === id) state.currentTestId = null;
  if (state.useFirebase) await deleteTestFromFirebase(id);
  saveLocal();
  renderManage();
  initAdmin();
  toast('–¢–µ—Å—Ç –≤–∏–¥–∞–ª–µ–Ω–æ', 'success');
}

// ============================================================
// MANAGE PAGE
// ============================================================
function renderManage() {
  const grid = document.getElementById('tests-grid');
  if (!state.tests.length) {
    grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="icon">üìã</div><p>–©–µ –Ω–µ–º–∞—î –∂–æ–¥–Ω–æ–≥–æ —Ç–µ—Å—Ç—É.</p></div>';
  } else {
    grid.innerHTML = '';
    state.tests.forEach(t => {
      const totalTime = (t.questions || []).reduce((s, q) => s + (q.time || 0), 0);
      const div = document.createElement('div');
      div.className = 'test-manage-card';
      div.innerHTML = `
        <div class="tmcard-title">${t.name}</div>
        <div class="tmcard-meta">${t.desc || '–ë–µ–∑ –æ–ø–∏—Å—É'} ¬∑ ${(t.questions||[]).length} –ø–∏—Ç–∞–Ω—å ¬∑ ‚âà${totalTime}—Å</div>
        <div class="tmcard-actions">
          <button class="btn btn-secondary btn-sm" onclick="editTestInAdmin('${t.id}')">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
          <button class="btn btn-cyan btn-sm" onclick="goTest('${t.id}')">üéØ –ü—Ä–æ–π—Ç–∏</button>
          <button class="btn btn-danger btn-sm" onclick="deleteTest('${t.id}')">üóë</button>
        </div>`;
      grid.appendChild(div);
    });
  }

  const rt = document.getElementById('results-table');
  if (!state.results.length) {
    rt.innerHTML = '<div class="empty-state"><div class="icon">üìä</div><p>–†–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –ø–æ–∫–∏ –Ω–µ–º–∞—î</p></div>';
    return;
  }
  let html = `<div style="overflow-x:auto;"><table style="width:100%;border-collapse:collapse;font-size:13px;">
    <thead><tr style="border-bottom:1px solid var(--border);">
      ${['–°—Ç—É–¥–µ–Ω—Ç','–¢–µ—Å—Ç','–†–µ–∑—É–ª—å—Ç–∞—Ç','–ü—Ä–∞–≤–∏–ª—å–Ω–∏—Ö','–ß–∞—Å','–î–∞—Ç–∞'].map(h => `<th style="padding:10px 12px;text-align:left;color:var(--muted);font-weight:600;">${h}</th>`).join('')}
    </tr></thead><tbody>`;
  state.results.slice().reverse().forEach(r => {
    const color = r.pct >= 80 ? 'var(--success)' : r.pct >= 50 ? 'var(--accent3)' : 'var(--danger)';
    html += `<tr style="border-bottom:1px solid var(--border);">
      <td style="padding:10px 12px;font-weight:500;">${r.student}</td>
      <td style="padding:10px 12px;color:var(--muted);">${r.testName}</td>
      <td style="padding:10px 12px;font-weight:700;color:${color};">${r.pct}%</td>
      <td style="padding:10px 12px;">${r.correct}/${r.total}</td>
      <td style="padding:10px 12px;color:var(--muted);">${r.timeTaken}—Å</td>
      <td style="padding:10px 12px;color:var(--muted);">${r.date}</td>
    </tr>`;
  });
  html += '</tbody></table></div>';
  rt.innerHTML = html;
}

function editTestInAdmin(id) {
  state.currentTestId = id;
  showPage('admin');
  document.getElementById('admin-test-select').value = id;
  renderQuestionList();
}

// ============================================================
// TEST SESSION
// ============================================================
function initTestPage() {
  stopTimer();
  state.acActive = false;
  document.getElementById('test-selector').style.display = 'block';
  document.getElementById('test-start').style.display = 'none';
  document.getElementById('test-question').style.display = 'none';
  document.getElementById('test-results').style.display = 'none';

  const cards = document.getElementById('test-cards');
  if (!state.tests.length) {
    cards.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="icon">üìã</div><p>–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö —Ç–µ—Å—Ç—ñ–≤.</p></div>';
    return;
  }
  cards.innerHTML = '';
  state.tests.forEach(t => {
    const totalTime = (t.questions || []).reduce((s, q) => s + (q.time || 0), 0);
    const div = document.createElement('div');
    div.className = 'test-card-item';
    div.innerHTML = `
      <div class="test-card-title">${t.name}</div>
      <div class="test-card-meta" style="margin-bottom:16px;">${t.desc || ''}</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;">
        <span class="badge badge-answers">${(t.questions||[]).length} –ø–∏—Ç–∞–Ω—å</span>
        <span class="badge badge-time">‚âà${totalTime}—Å</span>
      </div>
      <button class="btn btn-primary" style="width:100%;justify-content:center;" onclick="selectTest('${t.id}')">–ü–æ—á–∞—Ç–∏ ‚Üí</button>`;
    cards.appendChild(div);
  });
}

function goTest(id) { showPage('test'); selectTest(id); }

function selectTest(id) {
  const test = state.tests.find(t => t.id === id);
  if (!test || !(test.questions?.length)) { toast('–¢–µ—Å—Ç –ø–æ—Ä–æ–∂–Ω—ñ–π!', 'error'); return; }
  state.sessionTest = test;

  // Use logged-in user's name
  const user = fbUser();
  state.sessionStudent = user?.displayName || user?.email || '–ê–Ω–æ–Ω—ñ–º';

  document.getElementById('test-selector').style.display = 'none';
  document.getElementById('test-start').style.display = 'block';
  document.getElementById('start-test-title').textContent = test.name;
  document.getElementById('start-test-desc').textContent = test.desc || '';
  document.getElementById('start-q-count').textContent = test.questions.length;
  const avgTime = Math.round(test.questions.reduce((s, q) => s + q.time, 0) / test.questions.length);
  document.getElementById('start-avg-time').textContent = avgTime + '—Å';
}

function beginTest() {
  document.getElementById('test-start').style.display = 'none';
  document.getElementById('test-question').style.display = 'block';
  state.sessionAnswers = [];
  state.sessionCurrent = 0;
  state.sessionScore = 0;
  state.sessionCorrect = 0;
  state.sessionWrong = 0;
  state.sessionStartTime = Date.now();
  state.acViolations = 0;
  state.acActive = true;
  _initW = window.innerWidth;
  _initH = window.innerHeight;
  showQuestion();
}

function showQuestion() {
  const test = state.sessionTest;
  const qi = state.sessionCurrent;
  const q = test.questions[qi];

  document.getElementById('q-progress-text').textContent = `–ü–∏—Ç–∞–Ω–Ω—è ${qi + 1} –∑ ${test.questions.length}`;
  document.getElementById('q-score-text').textContent = `${state.sessionScore} –±–∞–ª—ñ–≤`;
  document.getElementById('progress-fill').style.width = (qi / test.questions.length * 100) + '%';
  document.getElementById('current-q-text').textContent = q.text;
  document.getElementById('q-feedback').textContent = '';
  document.getElementById('next-btn').style.display = 'none';

  const typeLabels = { single: '–û–ë–ï–†–Ü–¢–¨ –û–î–ù–£ –í–Ü–î–ü–û–í–Ü–î–¨', multiple: '–û–ë–ï–†–Ü–¢–¨ –í–°–Ü –ü–†–ê–í–ò–õ–¨–ù–Ü', text: '–¢–ï–ö–°–¢–û–í–ê –í–Ü–î–ü–û–í–Ü–î–¨' };
  document.getElementById('q-type-label').textContent = typeLabels[q.type];

  const optWrap = document.getElementById('current-options');
  const letters = 'ABCDEFGHIJ';

  if (q.type === 'text') {
    optWrap.innerHTML = `
      <div class="text-answer-wrap">
        <textarea class="textarea" id="text-input" placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å..." style="min-height:90px;"></textarea>
      </div>
      <div style="margin-top:12px;">
        <button class="btn btn-primary" id="submit-text-btn" onclick="submitTextAnswer()">–í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏ ‚Üí</button>
      </div>`;
  } else {
    // ‚úÖ FIX: Build options fresh, no innerHTML reuse conflict
    const grid = document.createElement('div');
    grid.className = 'options-grid';
    q.options.forEach((opt, i) => {
      const btn = document.createElement('button');
      btn.className = 'option-btn';
      btn.dataset.idx = i;
      btn.innerHTML = `<span class="opt-letter">${letters[i]}</span><span>${opt}</span>`;
      btn.addEventListener('click', () => selectOption(btn, i));
      grid.appendChild(btn);
    });
    optWrap.innerHTML = '';
    optWrap.appendChild(grid);

    if (q.type === 'multiple') {
      const submitWrap = document.createElement('div');
      submitWrap.style.marginTop = '14px';
      const submitBtn = document.createElement('button');
      submitBtn.className = 'btn btn-primary';
      submitBtn.id = 'submit-multiple-btn';
      submitBtn.textContent = '–í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏ ‚Üí';
      submitBtn.addEventListener('click', submitMultiple);
      submitWrap.appendChild(submitBtn);
      optWrap.appendChild(submitWrap);
    }
  }

  startTimer(q.time);
}

// TIMER
let timerInterval = null;
function startTimer(secs) {
  stopTimer();
  let remaining = secs;
  updateTimerDisplay(remaining);
  timerInterval = setInterval(() => {
    remaining--;
    updateTimerDisplay(remaining);
    if (remaining <= 0) { stopTimer(); timeOut(); }
  }, 1000);
}
function stopTimer() { if (timerInterval) { clearInterval(timerInterval); timerInterval = null; } }
function updateTimerDisplay(s) {
  const el = document.getElementById('timer-display');
  if (!el) return;
  el.textContent = `‚è± ${s}—Å`;
  el.className = 'timer-display' + (s <= 5 ? ' danger' : '');
}
function timeOut() {
  disableOptions();
  showFeedback(false, '–ß–∞—Å –≤–∏–π—à–æ–≤! ‚è∞');
  state.sessionWrong++;
  document.getElementById('next-btn').style.display = 'inline-flex';
}

function selectOption(btn, idx) {
  const q = state.sessionTest.questions[state.sessionCurrent];
  if (q.type === 'single') {
    document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    stopTimer();
    disableOptions();
    const correct = q.correct.includes(idx);
    highlightCorrect(q);
    if (correct) { state.sessionScore += 10; state.sessionCorrect++; showFeedback(true, '–ü—Ä–∞–≤–∏–ª—å–Ω–æ! +10 –±–∞–ª—ñ–≤ üéâ'); }
    else { state.sessionWrong++; showFeedback(false, '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ üòï'); }
    document.getElementById('next-btn').style.display = 'inline-flex';
  } else {
    // multiple: just toggle
    btn.classList.toggle('selected');
  }
}

function submitMultiple() {
  const q = state.sessionTest.questions[state.sessionCurrent];
  stopTimer();
  // Disable submit button
  const submitBtn = document.getElementById('submit-multiple-btn');
  if (submitBtn) submitBtn.disabled = true;

  const selected = [...document.querySelectorAll('.option-btn.selected')].map(b => parseInt(b.dataset.idx));
  const correctSorted = [...q.correct].sort((a,b) => a-b);
  const selectedSorted = [...selected].sort((a,b) => a-b);
  const correct = JSON.stringify(selectedSorted) === JSON.stringify(correctSorted);

  disableOptions();
  highlightCorrect(q);

  if (correct) { state.sessionScore += 10; state.sessionCorrect++; showFeedback(true, '–ü—Ä–∞–≤–∏–ª—å–Ω–æ! +10 –±–∞–ª—ñ–≤ üéâ'); }
  else { state.sessionWrong++; showFeedback(false, '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ üòï'); }
  document.getElementById('next-btn').style.display = 'inline-flex';
}

function submitTextAnswer() {
  const q = state.sessionTest.questions[state.sessionCurrent];
  const val = (document.getElementById('text-input')?.value || '').trim().toLowerCase();
  stopTimer();
  const textInput = document.getElementById('text-input');
  const submitBtn = document.getElementById('submit-text-btn');
  if (textInput) textInput.disabled = true;
  if (submitBtn) submitBtn.disabled = true;
  const correct = q.answer && val === q.answer.toLowerCase();
  if (correct) { state.sessionScore += 10; state.sessionCorrect++; showFeedback(true, '–ü—Ä–∞–≤–∏–ª—å–Ω–æ! +10 –±–∞–ª—ñ–≤ üéâ'); }
  else { state.sessionWrong++; showFeedback(false, q.answer ? `–ü—Ä–∞–≤–∏–ª—å–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å: ${q.answer}` : '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ üòï'); }
  document.getElementById('next-btn').style.display = 'inline-flex';
}

function highlightCorrect(q) {
  document.querySelectorAll('.option-btn').forEach(b => {
    const i = parseInt(b.dataset.idx);
    if (q.correct.includes(i)) b.classList.add('correct');
    else if (b.classList.contains('selected')) b.classList.add('wrong');
  });
}
function disableOptions() {
  document.querySelectorAll('.option-btn').forEach(b => { b.disabled = true; });
}
function showFeedback(ok, msg) {
  const el = document.getElementById('q-feedback');
  if (!el) return;
  el.textContent = msg;
  el.style.color = ok ? 'var(--success)' : 'var(--danger)';
}

function nextQuestion() {
  state.sessionCurrent++;
  if (state.sessionCurrent >= state.sessionTest.questions.length) finishTest();
  else showQuestion();
}

async function finishTest() {
  stopTimer();
  state.acActive = false;
  document.getElementById('test-question').style.display = 'none';
  document.getElementById('test-results').style.display = 'block';

  const total = state.sessionTest.questions.length;
  const pct = Math.round(state.sessionCorrect / total * 100);
  const timeTaken = Math.round((Date.now() - state.sessionStartTime) / 1000);

  document.getElementById('res-percent').textContent = pct + '%';
  document.getElementById('res-correct').textContent = state.sessionCorrect;
  document.getElementById('res-wrong').textContent = state.sessionWrong;
  document.getElementById('res-time').textContent = timeTaken + '—Å';

  let title, sub;
  if (pct >= 90) { title = '–í—ñ–¥–º—ñ–Ω–Ω–æ! üèÜ'; sub = '–ë–ª–∏—Å–∫—É—á–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!'; }
  else if (pct >= 70) { title = '–î–æ–±—Ä–µ! üëç'; sub = '–ù–µ–ø–æ–≥–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –Ñ –∫—É–¥–∏ —Ä–æ—Å—Ç–∏!'; }
  else if (pct >= 50) { title = '–ó–∞–¥–æ–≤—ñ–ª—å–Ω–æ üòê'; sub = '–ú–∞—Ç–µ—Ä—ñ–∞–ª –∑–∞—Å–≤–æ—î–Ω–æ —á–∞—Å—Ç–∫–æ–≤–æ.'; }
  else { title = '–ü–æ—Ç—Ä—ñ–±–Ω–æ –ø–æ–ª—ñ–ø—à–∏—Ç–∏ üìö'; sub = '–ü–æ–≤—Ç–æ—Ä—ñ—Ç—å –º–∞—Ç–µ—Ä—ñ–∞–ª —ñ —Å–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.'; }

  document.getElementById('res-title').textContent = title;
  document.getElementById('res-sub').textContent = sub;
  document.querySelector('.result-circle').style.borderColor = pct >= 70 ? 'var(--success)' : pct >= 50 ? 'var(--accent3)' : 'var(--danger)';

  const result = {
    student: state.sessionStudent,
    userId: fbUser()?.uid || 'demo',
    testName: state.sessionTest.name,
    testId: state.sessionTest.id,
    pct, correct: state.sessionCorrect, total,
    timeTaken, score: state.sessionScore,
    date: new Date().toLocaleDateString('uk-UA')
  };
  state.results.push(result);
  if (state.useFirebase) await saveResultToFirebase(result);
  saveLocal();
}

function retakeTest() {
  document.getElementById('test-results').style.display = 'none';
  selectTest(state.sessionTest.id);
}

// ============================================================
// MODAL
// ============================================================
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); });
});

// ============================================================
// TOAST
// ============================================================
function toast(msg, type = 'success') {
  const icons = { success: '‚úÖ', error: '‚ùå', info: '‚ÑπÔ∏è' };
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.innerHTML = `<span>${icons[type]||'‚ÑπÔ∏è'}</span><span>${msg}</span>`;
  document.getElementById('toasts').appendChild(t);
  setTimeout(() => { t.style.opacity = '0'; }, 2500);
  setTimeout(() => t.remove(), 3000);
}

// ============================================================
// ANTI-CHEAT
// ============================================================
function isTestActive() {
  return state.acActive &&
    document.getElementById('test-question') &&
    document.getElementById('test-question').style.display !== 'none';
}
function acTrigger(reason) {
  if (!isTestActive()) return;
  stopTimer();
  state.acViolations++;
  const overlay = document.getElementById('anticheat-overlay');
  overlay.style.display = 'flex';
  document.getElementById('ac-reason').textContent = reason;
  document.getElementById('ac-violations-badge').textContent = `‚ö†Ô∏è –ü–æ—Ä—É—à–µ–Ω—å: ${state.acViolations} / ${state.acMaxViolations}`;
  const remaining = state.acMaxViolations - state.acViolations;
  const actions = document.getElementById('ac-actions');
  if (state.acViolations >= state.acMaxViolations) {
    document.getElementById('ac-icon').textContent = 'üö´';
    document.getElementById('ac-title').textContent = '–¢–µ—Å—Ç –∞–Ω—É–ª—å–æ–≤–∞–Ω–æ!';
    document.getElementById('ac-warning').textContent = '–õ—ñ–º—ñ—Ç –ø–æ—Ä—É—à–µ–Ω—å –≤–∏—á–µ—Ä–ø–∞–Ω–æ. –†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –∑–∞—Ä–∞—Ö–æ–≤—É—î—Ç—å—Å—è.';
    actions.innerHTML = `<button class="btn btn-danger" onclick="acDisqualify()">–ó–∞–≤–µ—Ä—à–∏—Ç–∏ —Ç–µ—Å—Ç</button>`;
  } else {
    document.getElementById('ac-icon').textContent = '‚ö†Ô∏è';
    document.getElementById('ac-title').textContent = '–£–≤–∞–≥–∞! –ü–æ—Ä—É—à–µ–Ω–Ω—è –∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ';
    document.getElementById('ac-warning').textContent = `–©–µ ${remaining} –ø–æ—Ä—É—à–µ–Ω–Ω—è ‚Äî —ñ —Ç–µ—Å—Ç –±—É–¥–µ –∞–Ω—É–ª—å–æ–≤–∞–Ω–æ.`;
    actions.innerHTML = `
      <button class="btn btn-primary" onclick="acResume()">–ü–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—å –¥–æ —Ç–µ—Å—Ç—É</button>
      <button class="btn btn-danger btn-sm" onclick="acDisqualify()">–ó–∞–≤–µ—Ä—à–∏—Ç–∏</button>`;
  }
}
function acResume() {
  document.getElementById('anticheat-overlay').style.display = 'none';
  const q = state.sessionTest.questions[state.sessionCurrent];
  startTimer(Math.max(5, q.time - 3));
}
async function acDisqualify() {
  state.acActive = false;
  document.getElementById('anticheat-overlay').style.display = 'none';
  document.getElementById('test-question').style.display = 'none';
  document.getElementById('test-results').style.display = 'block';
  const total = state.sessionTest.questions.length;
  state.sessionWrong += (total - state.sessionCurrent);
  const pct = Math.round(state.sessionCorrect / total * 100);
  const timeTaken = Math.round((Date.now() - state.sessionStartTime) / 1000);
  document.getElementById('res-percent').textContent = pct + '%';
  document.getElementById('res-correct').textContent = state.sessionCorrect;
  document.getElementById('res-wrong').textContent = state.sessionWrong;
  document.getElementById('res-time').textContent = timeTaken + '—Å';
  document.getElementById('res-title').textContent = 'üö´ –¢–µ—Å—Ç –∞–Ω—É–ª—å–æ–≤–∞–Ω–æ';
  document.getElementById('res-sub').textContent = `–ó–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ ${state.acViolations} –ø–æ—Ä—É—à–µ–Ω—å.`;
  document.querySelector('.result-circle').style.borderColor = 'var(--danger)';
  const result = {
    student: state.sessionStudent + ' [–ü–û–†–£–®–ï–ù–ù–Ø]',
    userId: fbUser()?.uid || 'demo',
    testName: state.sessionTest.name, testId: state.sessionTest.id,
    pct: 0, correct: state.sessionCorrect, total, timeTaken, score: 0,
    date: new Date().toLocaleDateString('uk-UA')
  };
  state.results.push(result);
  if (state.useFirebase) await saveResultToFirebase(result);
  saveLocal();
}

document.addEventListener('visibilitychange', () => {
  if (document.hidden) acTrigger('–í–∫–ª–∞–¥–∫–∞ –±—É–ª–∞ –∑–≥–æ—Ä–Ω—É—Ç–∞ –∞–±–æ –ø—Ä–∏—Ö–æ–≤–∞–Ω–∞.');
});
window.addEventListener('blur', () => {
  acTrigger('–í—ñ–∫–Ω–æ –±—Ä–∞—É–∑–µ—Ä–∞ –≤—Ç—Ä–∞—Ç–∏–ª–æ —Ñ–æ–∫—É—Å.');
});
let _initW = window.innerWidth, _initH = window.innerHeight;
window.addEventListener('resize', () => {
  const dw = Math.abs(window.innerWidth - _initW);
  const dh = Math.abs(window.innerHeight - _initH);
  if (dw > 50 || dh > 50) {
    acTrigger('–†–æ–∑–º—ñ—Ä –≤—ñ–∫–Ω–∞ –±—É–ª–æ –∑–º—ñ–Ω–µ–Ω–æ.');
    _initW = window.innerWidth; _initH = window.innerHeight;
  }
});
</script>
</body>
</html>
